/* Point a) 	Добавляю в таблицу dbo.StateProvince поле SalesYTD MONEY и SumSales MONEY.   	Также создаю в таблице вычисляемое поле SalesPercent,   	вычисляющее процентное выражение значения в поле SumSales от значения в поле SalesYTD. */ ALTER TABLE dbo.StateProvince     ADD SalesYTD MONEY;  ALTER TABLE dbo.StateProvince     ADD SumSales MONEY;  ALTER TABLE dbo.StateProvince     ADD SalesPercent AS Round(SalesYTD / SumSales * 100, 0) persisted;  SELECT * 
	FROM dbo.StateProvince
GO /* Point b) 	Создаю временную таблицу #StateProvince, с первичным ключом по полю StateProvinceID.  	Временная таблица включает все поля таблицы dbo.StateProvince за исключением поля SalesPercent. */ CREATE TABLE #StateProvince (     StateProvinceId [INT] NOT NULL PRIMARY KEY,     StateProvinceCode [NCHAR](3) NOT NULL,     CountryRegionCode [NVARCHAR](3) NOT NULL,     Name VARCHAR(50) NOT NULL,     TerritoryId [INT] NOT NULL,     ModifiedDate [DATETIME] NOT NULL,     CountryNum [INT],     SalesYTD MONEY,     SumSales MONEY );  SELECT * FROM #StateProvince
GO  /* Point c) 	Заполняю временную таблицу данными из dbo.StateProvince. Поле SalesYTD заполняю значениями из таблицы Sales.SalesTerritory.   	Считаю сумму продаж (SalesYTD) для каждой территории (TerritoryID) в таблице Sales.SalesPerson и заполняю этими значениями поле SumSales.   	Подсчет суммы продаж осуществляю в Common Table Expression (CTE). */ WITH SumSales_cte          AS (SELECT ST.TerritoryId,                     Sum(ST.SaleSlastYear) AS SumSales              FROM dbo.StateProvince AS SP                       JOIN sales.SalesTerritory AS ST                            ON SP.TerritoryId = ST.TerritoryId              GROUP BY ST.territoryid) INSERT INTO #StateProvince      SELECT SP.StateProvinceId,     SP.StateProvinceCode,     SP.CountryRegionCode,     SP.Name,     SP.TerritoryId,     SP.ModifiedDate,     SP.CountryNum,     ST.SaleSlastYear,     SS.SumSales FROM [dbo].[StateProvince] AS SP     JOIN sales.SalesTerritory AS ST ON SP.TerritoryId = ST.TerritoryId     JOIN SumSales_cte AS SS     ON SS.TerritoryId = SP.TerritoryId;  SELECT * FROM #StateProvince
GO  /* Point d) 	Удаляю из таблицы dbo.StateProvince одну строку (где StateProvinceID = 5). */ DELETE 	FROM dbo.StateProvince 	WHERE StateProvinceId = 5;  SELECT * FROM dbo.StateProvince
GO  /* Point e) 	Пишу Merge выражение, использующее dbo.StateProvince как target, а временную таблицу как source.  	Для связи target и source использую StateProvinceID.  	Обновляю поля SalesYTD и SumSales, если запись присутствует в source и target.  	Если строка присутствует во временной таблице, но не существует в target, добавляю строку в dbo.StateProvince.  	Если в dbo.StateProvince присутствует такая строка, которой не существует во временной таблице, удаляю строку из dbo.StateProvince. */ MERGE dbo.StateProvince AS TARGET  	USING #StateProvince AS SOURCE  		ON TARGET.StateProvinceId = source.StateProvinceId  	WHEN matched THEN 		UPDATE  			SET TARGET.SalesYTD = SOURCE.SalesYTD, 				TARGET.SumSales = SOURCE.SumSales 	WHEN NOT matched BY target THEN 		INSERT VALUES ( 			StateProvinceCode, 			CountryRegionCode, 			Name, 			TerritoryId, 			ModifiedDate, 			CountryNum, 			SalesYTD, 			SumSales 		) 	WHEN NOT matched BY source THEN 		DELETE; 		 SELECT * FROM dbo.StateProvince
GO